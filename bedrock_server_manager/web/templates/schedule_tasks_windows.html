<!-- bedrock-server-manager/bedrock_server_manager/web/templates/schedule_tasks_windows.html -->
{% extends "base.html" %}

{# Set the page title #}
{% block title %}{{ super() }} - Task Scheduler: {{ server_name }}{% endblock %}

{# Add page-specific CSS/JS to the head #}
{% block head_scripts %}
    <script>
        // Use a namespace or specific variable names
        const pageConfig = {
            serverName: "{{ server_name | e }}",
            csrfToken: "{{ csrf_token() }}"
        };
    </script>
    <script src="{{ url_for('static', filename='js/utils.js') }}" defer></script>
    {# fillModifyFormWindows, confirmDeleteWindows, prepareNewTaskForm, addTrigger, cancelTaskForm #}
    <script src="{{ url_for('static', filename='js/windows_task.js') }}" defer></script>
{% endblock %}

{# Import the trigger macro if JS doesn't handle HTML generation #}
{% from 'schedule_trigger.html' import render_trigger_fields with context %}

{# Main content for this page #}
{% block content %}
    {# Page Heading #}
    <h2>Windows Task Scheduler</h2>
    <p style="margin-bottom: 15px;">Server: <strong>{{ server_name }}</strong></p>

    {# Area for JavaScript-driven status messages - Hidden by default #}
    <div id="status-message-area" class="message-box" style="display: none; min-height: 1.5em; margin-bottom: 15px;">
        <!-- Status messages appear here -->
    </div>

    {# Server-side flash messages handled by base.html #}

    {# Section to Display Existing Tasks #}
    <section class="windows-tasks-section list-section"> {# Added list-section #}
        <h3>Current Scheduled Tasks</h3> {# Changed to H3 #}
        <div id="task-list-container">
            {% if tasks %}
                 <div class="table-responsive-wrapper"> {# Add Wrapper #}
                    <table class="server-table">
                        <thead>
                            <tr>
                                <th scope="col">Task Name</th>
                                <th scope="col">Command</th>
                                <th scope="col">Schedule</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in tasks %}
                            <tr>
                                <td data-label="Task Name">{{ task.task_name }}</td>
                                <td data-label="Command">{{ task.command }}</td>
                                <td data-label="Schedule">{{ task.schedule }}</td>
                                <td data-label="Actions">
                                    {# Use links styled like buttons for consistency? Or keep action-link? #}
                                    <a href="#" onclick="event.preventDefault(); fillModifyFormWindows('{{ task.task_name | e }}')" class="action-link modify-link">Modify</a>
                                    <a href="#" onclick="event.preventDefault(); confirmDeleteWindows('{{ task.task_name | e }}')" class="action-link delete-link">Delete</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div> {# End Wrapper #}
            {% else %}
                 <p class="no-servers">No scheduled tasks found for this server.</p>
            {% endif %}
        </div> {# End task-list-container #}

        {# Actions related to the list view #}
        <div class="list-actions form-actions"> {# Consistent actions wrapper #}
            <button type="button" onclick="prepareNewTaskForm()" class="main-button">Add New Task</button>
            <a href="{{ url_for('main_routes.index') }}" class="main-button">Back to Dashboard</a>
        </div>
    </section>

    {# Section for Add/Modify Form (Initially hidden) #}
    <section class="add-modify-task-section" id="add-modify-task-section" style="display: none;"> {# Keep hidden #}
        <h2 id="form-title">Add New Task</h2> {# JS will change this to "Modify Task" #}
        {# Use POST if submitting normally, not needed if all via JS fetch #}
        <form id="task-form" onsubmit="event.preventDefault(); handleTaskFormSubmit(this);">
             {# Add CSRF token if JS submit needs it #}
             <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
             {# Hidden input to store the original task name when modifying #}
             <input type="hidden" id="original_task_name" name="original_task_name" value="">

             <div class="form-group">
                <label for="command" class="form-label">Command:</label>
                <select id="command" name="command" class="form-input" required>
                    <option value="" disabled selected>-- Select Command --</option>
                    <option value="update-server">Update Server</option>
                    <option value="backup-all">Backup Server</option>
                    <option value="start-server">Start Server</option>
                    <option value="stop-server">Stop Server</option>
                    <option value="restart-server">Restart Server</option>
                    <option value="scan-players">Scan Players</option>
                </select>
                 <div class="validation-error" data-field="command"></div>
            </div>

            <hr>
            <h3>Triggers</h3>
            {# Container where JS/macro adds trigger groups #}
            <div id="triggers-container">
                {# Example: Render first trigger using macro initially? #}
                {# {{ render_trigger_fields(1) }} #}
                {# OR let JS add the first one via prepareNewTaskForm #}
            </div>
            <button type="button" onclick="addTrigger()" class="secondary-button">Add Another Trigger</button>
            <hr>

            {# Form submission buttons #}
             <div class="form-actions">
                <button type="submit" class="main-button" id="submit-task-btn">Save Task</button>
                <button type="button" onclick="cancelTaskForm()" class="action-link cancel-button">Cancel</button> {# Style Cancel as link? #}
            </div>
        </form>
    </section>

{% endblock %}