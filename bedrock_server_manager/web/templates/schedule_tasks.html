<!-- bedrock-server-manager/bedrock_server_manager/web/templates/schedule_tasks.html -->
{% extends "base.html" %}

{# Set the page title #}
{% block title %}{{ super() }} - Task Scheduler: {{ server_name }}{% endblock %}

{# Add page-specific JS to the head #}
{% block head_scripts %}
    <script>
        // Use a namespace or specific variable names
        const pageConfig = {
            serverName: "{{ server_name | e }}",
            csrfToken: "{{ csrf_token() }}"
        };
    </script>
    <script src="{{ url_for('static', filename='js/utils.js') }}" defer></script>
    {# Add the JS file that contains fillModifyForm, confirmDelete, and form submission logic #}
    <script src="{{ url_for('static', filename='js/linux_task.js') }}" defer></script> {# Example filename #}
{% endblock %}


{# Main content for this page #}
{% block content %}
    {# Page Heading #}
    <h2>Cron Job Scheduler</h2>
    <p style="margin-bottom: 15px;">Server: <strong>{{ server_name }}</strong></p>

    {# Area for JavaScript-driven status messages - Hidden by default #}
    <div id="status-message-area" class="message-box" style="display: none; min-height: 1.5em; margin-bottom: 15px;">
        <!-- Status messages appear here -->
    </div>

    {# Server-side flash messages handled by base.html #}

    {# Section to Display Existing Cron Jobs #}
    <section class="schedule-tasks-section list-section"> {# Added list-section #}
        <h3>Current Scheduled Jobs</h3> {# Changed to H3 #}
        {% if table_data %}
             <div class="table-responsive-wrapper"> {# Add Wrapper #}
                <table class="server-table">
                    <thead>
                        <tr>
                            <th scope="col">Min</th>
                            <th scope="col">Hour</th>
                            <th scope="col">Day</th>
                            <th scope="col">Mon</th>
                            <th scope="col">DoW</th>
                            <th scope="col">Schedule</th> {# Readable time #}
                            <th scope="col">Command</th> {# Display command #}
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for job in table_data %}
                            <tr>
                                <td data-label="Min">{{ job.minute }}</td>
                                <td data-label="Hour">{{ job.hour }}</td>
                                <td data-label="Day">{{ job.day_of_month }}</td>
                                <td data-label="Mon">{{ job.month }}</td>
                                <td data-label="DoW">{{ job.day_of_week }}</td>
                                <td data-label="Schedule">{{ job.schedule_time }}</td>
                                <td data-label="Command">{{ job.command_display }}</td>
                                <td data-label="Actions">
                                    {# Pass escaped arguments to JS functions #}
                                    <a href="#" onclick="event.preventDefault(); fillModifyForm('{{ job.minute | e }}', '{{ job.hour | e }}', '{{ job.day_of_month | e }}', '{{ job.month | e }}', '{{ job.day_of_week | e }}', '{{ job.command | e }}')" class="action-link modify-link">Modify</a>
                                    {# Construct original string for delete #}
                                    <a href="#" onclick="event.preventDefault(); confirmDelete('{{ job.minute | e }} {{ job.hour | e }} {{ job.day_of_month | e }} {{ job.month | e }} {{ job.day_of_week | e }} {{ job.command | e }}')" class="action-link delete-link">Delete</a>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div> {# End Wrapper #}
        {% else %}
             <p class="no-servers">No cron jobs scheduled for this server.</p>
        {% endif %}

        {# Actions related to the list view #}
        <div class="list-actions form-actions"> {# Consistent actions wrapper #}
             {# Maybe a button to scroll down/show the Add form instead of always visible? #}
             {# <button type="button" onclick="showAddForm()" class="main-button">Add New Job</button> #}
             <a href="{{ url_for('main_routes.index') }}" class="main-button">Back to Dashboard</a>
        </div>
    </section>

    {# Section for Add/Modify Form #}
    <section class="add-cron-job-section" id="add-modify-cron-section"> {# Use ID if hiding/showing #}
        {# JS should change this title when modifying #}
        <h2 id="cron-form-title">Add/Modify Cron Job</h2>
        {# Add onsubmit handler #}
        <form id="cron-form" onsubmit="event.preventDefault(); handleCronFormSubmit(this);">
             {# Add CSRF token if needed by JS submit #}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            {# Command Selection #}
            <div class="form-group">
                <label for="command" class="form-label">Command:</label> {# Added form-label class #}
                <select id="command" name="command" class="form-input" required>
                    <option value="" disabled selected>-- Select Command --</option>
                    <option value="update-server">Update Server</option>
                    <option value="backup-all">Backup Server</option>
                    <option value="start-server">Start Server</option>
                    <option value="stop-server">Stop Server</option>
                    <option value="restart-server">Restart Server</option>
                    <option value="scan-players">Scan Players</option>
                </select>
                <div class="validation-error" data-field="command"></div>
            </div>

            {# Cron Time Fields - maybe use form-grid here? #}
            <div class="form-grid cron-grid"> {# Added form-grid and specific class #}
                <div class="form-group">
                    <label for="minute" class="form-label">Minute (0-59):</label>
                    <input type="text" id="minute" name="minute" class="form-input" value="*" required pattern="^(\*|([0-5]?\d)(-[0-5]?\d)?(,[0-5]?\d(-[0-5]?\d)?)*|\*\/([1-9]|[1-5]\d))$">
                    <small class="form-help-text">Examples: *, 0, 15, 0-30, */15</small>
                    <div class="validation-error" data-field="minute"></div>
                </div>
                <div class="form-group">
                    <label for="hour" class="form-label">Hour (0-23):</label>
                    <input type="text" id="hour" name="hour" class="form-input" value="*" required pattern="^(\*|([01]?\d|2[0-3])(-([01]?\d|2[0-3]))?(,([01]?\d|2[0-3])(-([01]?\d|2[0-3]))?)*|\*\/([1-9]|1\d|2[0-3]))$">
                    <small class="form-help-text">Examples: *, 0, 10, 8-17, */2</small>
                    <div class="validation-error" data-field="hour"></div>
                </div>
                <div class="form-group">
                    <label for="day" class="form-label">Day of Month (1-31):</label>
                    <input type="text" id="day" name="day" class="form-input" value="*" required pattern="^(\*|([1-9]|[12]\d|3[01])(-([1-9]|[12]\d|3[01]))?(,([1-9]|[12]\d|3[01])(-([1-9]|[12]\d|3[01]))?)*|\*\/([1-9]|[12]\d|3[01]))$">
                    <small class="form-help-text">Examples: *, 1, 15, 1-15, */5</small>
                     <div class="validation-error" data-field="day"></div>
                </div>
                <div class="form-group">
                    <label for="month" class="form-label">Month (1-12):</label>
                    <input type="text" id="month" name="month" class="form-input" value="*" required pattern="^(\*|([1-9]|1[0-2])(-([1-9]|1[0-2]))?(,([1-9]|1[0-2])(-([1-9]|1[0-2]))?)*|\*\/([1-9]|1[0-2]))$">
                    <small class="form-help-text">Examples: *, 1, 6, 1-3, */2</small>
                    <div class="validation-error" data-field="month"></div>
                </div>
                <div class="form-group">
                    <label for="weekday" class="form-label">Day of Week (0-6, Sun=0):</label>
                    <input type="text" id="weekday" name="weekday" class="form-input" value="*" required pattern="^(\*|[0-6](-[0-6])?(,[0-6](-[0-6])?)*|\*\/[1-6])$">
                    <small class="form-help-text">Examples: *, 0, 5, 1-5, 0,6</small>
                     <div class="validation-error" data-field="weekday"></div>
                </div>
            </div> {# End .cron-grid #}

            {# Hidden field to store the original full cron string when modifying #}
            <input type="hidden" id="original_cron_string" name="original_cron_string" value="">

            {# Form submission buttons #}
            <div class="form-actions">
                 {# JS should change text to 'Modify Job' when needed #}
                <button type="submit" class="main-button" id="cron-submit-btn">Add Job</button>
                 {# Optional: Button to clear/reset form #}
                 {# <button type="button" onclick="resetCronForm()" class="action-link">Clear Form</button> #}
            </div>
        </form>
    </section>

{% endblock %}