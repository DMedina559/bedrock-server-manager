<!-- bedrock_server_manager//web/templates/configure_permissions.html -->
{# Extends the base layout template #}
{% extends "base.html" %}

{# --- Page Title Block --- #}
{% block title %}{{ super() }} - Configure Permissions: {{ server_name }}{% endblock %}

{# --- Head Scripts Block --- #}
{% block head_scripts %}
<script src="{{ url_for('static', filename='js/utils.js') }}" defer></script>
<script src="{{ url_for('static', filename='js/install_config.js') }}" defer></script>
{% endblock %}

{# --- Main Content Block --- #}
{% block content %}
<h2>Configure Player Permissions</h2>
<p style="margin-bottom: 15px;" data-server-name="{{ server_name | e }}">
    Server: <strong>{{ server_name }}</strong>
    {% if new_install %}
    <br><span class="step-indicator">(Step 3 of 4 for New Installation)</span>
    {% endif %}
</p>

<div id="status-message-area" class="message-box" style="opacity: 0; transition: opacity 0.5s ease-out;"></div>
<div id="validation-error-area" class="message-box message-error" style="margin-bottom: 15px; display: none;"></div>

<section class="permissions-config-section">
    <p>Set the permission level for each known player found in the global player list or existing permissions file.</p>

    <div class="table-responsive-wrapper">
        <table class="server-table">
            <thead>
                <tr>
                    <th scope="col">Player Name</th>
                    <th scope="col">XUID</th>
                    <th scope="col" style="min-width: 150px;">Permission Level</th>
                </tr>
            </thead>
            <tbody id="permissions-table-body">
                {# This will be filled by JavaScript. Show a loader initially. #}
                <tr>
                    <td colspan="3">
                        <div id="permissions-loader" class="loader-container-small">
                            <div class="spinner"></div>
                            <p>Loading player and permission data...</p>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="form-actions">
        <button type="button"
                id="save-permissions-btn"
                onclick="savePermissions(this, '{{ server_name | e }}', {{ new_install | tojson }})"
                class="action-button start-button"
                disabled title="Loading player data...">
            Save Permissions
        </button>
        {% if new_install %}
        <a href="{{ url_for('install_config_routes.configure_service_route', server_name=server_name, new_install='True') }}" class="action-link">
            Skip & Go to Service Config »
        </a>
        {% else %}
        <a href="{{ url_for('main_routes.index') }}" class="action-link">
            « Back to Dashboard
        </a>
        {% endif %}
    </div>
</section>

    {# --- Templates for JavaScript --- #}
<template id="player-row-template">
    <tr>
        <td data-label="Player Name" class="player-name">PlayerName</td>
        <td data-label="XUID" class="player-xuid">PlayerXUID</td>
        <td data-label="Permission Level">
            <select name="player-xuid" class="form-input permission-select">
                <option value="visitor">Visitor</option>
                <option value="member">Member</option>
                <option value="operator">Operator</option>
            </select>
            <div class="validation-error inline-error"></div>
        </td>
    </tr>
</template>
<template id="no-players-row-template">
    <tr class="no-servers-row">
        <td colspan="3" class="no-servers">
            No players found. Cannot set permissions.
        </td>
    </tr>
</template>

{% endblock %}


{# --- Body Scripts Block --- #}
{% block body_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const serverName = document.querySelector('[data-server-name]').dataset.serverName;
        const tableBody = document.getElementById('permissions-table-body');
        const saveButton = document.getElementById('save-permissions-btn');
        const playerRowTemplate = document.getElementById('player-row-template');
        const noPlayersRowTemplate = document.getElementById('no-players-row-template');
        const loaderRow = tableBody.querySelector('tr'); // Get the initial loader row

        try {
            console.log("Fetching global players and server permissions in parallel...");
            // Refactor fetch to use sendServerActionRequest
            const [allPlayersData, serverPermissionsData] = await Promise.all([
                window.sendServerActionRequest(null, '/api/players/get', 'GET', null, null),
                window.sendServerActionRequest(serverName, 'permissions/get', 'GET', null, null)
            ]);

            // Check responses
            if (!allPlayersData || allPlayersData.status !== 'success') {
                throw new Error(allPlayersData.message || 'Failed to load global players.');
            }
            if (!serverPermissionsData || serverPermissionsData.status !== 'success') {
                throw new Error(serverPermissionsData.message || 'Failed to load server permissions.');
            }

            let allPlayers = allPlayersData.players || [];
            const serverPermissions = serverPermissionsData.data?.permissions || [];
            console.log(`Loaded ${allPlayers.length} global players and ${serverPermissions.length} server permissions.`);

            const permissionsMap = new Map(serverPermissions.map(p => [String(p.xuid), p.permission_level]));
            const knownPlayerXuids = new Set(allPlayers.map(p => String(p.xuid)));

            for (const [xuid, level] of permissionsMap.entries()) {
                if (!knownPlayerXuids.has(xuid)) {
                    allPlayers.push({ xuid: xuid, name: `Unknown (XUID: ${xuid})` });
                    console.log(`Found permission for unknown player ${xuid}, adding to list.`);
                }
            }

            allPlayers.sort((a, b) => (a.name || '').toLowerCase().localeCompare((b.name || '').toLowerCase()));

            tableBody.innerHTML = ''; // Clear the loader

            if (allPlayers.length === 0) {
                tableBody.appendChild(noPlayersRowTemplate.content.cloneNode(true));
                saveButton.title = "No players loaded to configure";
                saveButton.disabled = true; // Keep disabled if no players
                return;
            }

            const fragment = document.createDocumentFragment();
            allPlayers.forEach(player => {
                const rowClone = playerRowTemplate.content.cloneNode(true);
                const select = rowClone.querySelector('.permission-select');

                rowClone.querySelector('.player-name').textContent = player.name || 'N/A';
                rowClone.querySelector('.player-xuid').textContent = player.xuid || 'N/A';
                select.name = player.xuid; // Used by savePermissions
                select.dataset.xuid = player.xuid; // Also useful for identification
                const currentPermission = permissionsMap.get(String(player.xuid)) || 'member';
                select.value = currentPermission;
                rowClone.querySelector('.validation-error').dataset.field = player.xuid;
                fragment.appendChild(rowClone);
            });
            tableBody.appendChild(fragment);

            saveButton.disabled = false;
            saveButton.title = "Save all player permissions";

        } catch (error) {
            console.error('Failed to load permissions page data:', error);
            tableBody.innerHTML = ''; // Clear loader if it's still there
            // Use showStatusMessage for displaying the error
            if (typeof showStatusMessage === 'function') {
                showStatusMessage(`Error loading page data: ${error.message}`, 'error');
            } else {
                // Fallback if showStatusMessage somehow isn't available
                const errorRow = document.createElement('tr');
                errorRow.className = 'list-item-error';
                const errorCell = document.createElement('td');
                errorCell.colSpan = 3;
                errorCell.textContent = `Error loading page data: ${error.message}`;
                errorRow.appendChild(errorCell);
                tableBody.appendChild(errorRow);
            }
            saveButton.title = "Could not load data";
            saveButton.disabled = true; // Keep disabled on error
        }
    });
</script>
{% endblock %}