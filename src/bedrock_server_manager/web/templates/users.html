{% extends "base.html" %}

{% block title %}Bedrock Server Manager - Users{% endblock %}

{% block content %}
<div class="container">
    <h1>User Management</h1>
    {% if current_user.role == 'admin' %}
    <h2>Generate Registration Link</h2>
    <form id="generate-token-form">
        <div class="form-group">
            <label for="role">Role</label>
            <select id="role" name="role" class="form-input">
                <option value="user">User</option>
                <option value="moderator">Moderator</option>
                <option value="admin">Admin</option>
            </select>
        </div>
        <button type="button" class="action-button" onclick="generateToken()">Generate Link</button>
    </form>

    {% if 'message' in request.query_params and 'Registration link generated' in request.query_params['message'] %}
    <div class="message-box">
        <p>{{ request.query_params['message'] }}</p>
        <button class="action-button" onclick="copyToClipboard('{{ request.query_params['message'].split(': ')[1] }}')">Copy Link</button>
    </div>
    {% endif %}
    {% endif %}
    <h2>Existing Users</h2>
    <ul class="server-card-list">
        {% for user in users %}
        <li class="server-card">
            <div class="server-card-info">
                <h3>{{ user.username }}</h3>
                <p><span class="info-label">Role:</span> {{ user.role }}</p>
                {% if user.last_seen %}
                <p><span class="info-label">Last Seen:</span> {{ user.last_seen.strftime('%Y-%m-%d %H:%M:%S') }} UTC</p>
                {% endif %}
            </div>
            <div class="server-card-actions">
                {% if current_user.role == 'admin' %}
                <button type="button" class="danger-button" onclick="deleteUser('{{ user.id }}')">Delete</button>
                {% endif %}
            </div>
        </li>
        {% endfor %}
    </ul>
</div>
{% endblock %}

{% block body_scripts %}
<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        alert('Copied to clipboard');
    }, function(err) {
        alert('Could not copy text: ', err);
    });
}

function generateToken() {
    const form = document.getElementById('generate-token-form');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    sendServerActionRequest(null, "/register/generate-token", 'POST', data)
        .then(response => {
            if (response && response.status === 'success') {
                window.location.href = response.redirect_url;
            }
        });
}

function deleteUser(userId) {
    if (confirm('Are you sure you want to delete this user?')) {
        sendServerActionRequest(null, `/users/${userId}/delete`, 'POST')
            .then(response => {
                if (response && response.status === 'success') {
                    window.location.reload();
                }
            });
    }
}
</script>
{% endblock %}
